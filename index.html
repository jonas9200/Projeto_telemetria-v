<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGS Irrigação</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary: #2e7d32;
            --secondary: #00695c;
            --accent: #2196F3;
            --dark: #1a2a6c;
            --light: #f5f5f7;
            --success: #4CAF50;
            --warning: #FFC107;
            --danger: #F44336;
            --info: #2196F3;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
           background: linear-gradient(135deg, #fdbb2d, #1e3a8a, #1a2a6c );
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--accent);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--accent);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            margin: 5px 15px;
        }
        
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .connected {
            background-color: var(--success);
            box-shadow: 0 0 10px var(--success);
        }
        
        .disconnected {
            background-color: var(--danger);
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab-nav {
            display: flex;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tab-btn i {
            margin-right: 8px;
        }
        
        .tab-btn.active {
            background: var(--primary);
        }
        
        .tab-btn:hover {
            background: var(--secondary);
        }
        
        .tab-content {
            display: none;
            background: rgba(30, 30, 50, 0.8);
            border-radius: 0 0 10px 10px;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(30, 30, 50, 0.8);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        h2 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        h2 i {
            margin-right: 10px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, textarea, button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }
        
        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        button {
            background: var(--primary);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        button i {
            margin-right: 8px;
        }
        
        button:hover:not(:disabled) {
            background: var(--secondary);
            transform: translateY(-2px);
        }
        
        .btn-danger { background: var(--danger); }
        .btn-danger:hover:not(:disabled) { background: #d32f2f; }
        .btn-success { background: var(--success); }
        .btn-success:hover:not(:disabled) { background: #388E3C; }
        .btn-warning { background: var(--warning); color: #333; }
        .btn-warning:hover:not(:disabled) { background: #FFA000; }
        .btn-info { background: var(--info); }
        .btn-info:hover:not(:disabled) { background: #1976D2; }
        
        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .messages {
            height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
        }
        
        .message {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .timestamp { color: var(--accent); font-size: 0.8rem; }
        .topic { color: var(--success); font-weight: bold; }
        .payload { color: white; }
        
        .status-value {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.2);
        }
        
        .status-label { font-weight: bold; }
        .status-data { color: var(--accent); }
        
        .schedule-form {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .error-alert, .success-alert {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .error-alert {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid var(--danger);
            color: #ffcdd2;
        }
        
        .success-alert {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid var(--success);
            color: #c8e6c9;
        }
        
        .auth-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .auth-toggle input {
            width: auto;
            margin-right: 10px;
        }
        
        .auth-fields {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .auth-fields.active {
            display: grid;
        }
        
        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .weekdays {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .weekday {
            display: flex;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        
        .weekday input {
            width: auto;
            margin-right: 10px;
            margin-top: 0;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-right: 10px;
        }
        
        .switch input {
            opacity: 0; 
            width: 0; 
            height: 0; 
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .map-container {
            height: 400px;
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
        }
        
        #leaflet-map {
            height: 100%;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
            .status-bar { flex-direction: column; align-items: flex-start; }
            .status-item { margin-bottom: 10px; }
            .control-buttons, .time-inputs { grid-template-columns: 1fr; }
            .weekdays { grid-template-columns: repeat(2, 1fr); }
            h1 { font-size: 2rem; }
            .tab-nav { flex-direction: column; }
            .tab-btn { flex: none; }
            .auth-fields { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-tint"></i> AGS Irrigação</h1>
            <p class="subtitle" id="dynamic-subtitle"></p>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator connected" id="render-status"></div>
                    <span id="render-text">Sistema Carregado</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator disconnected" id="mqtt-status"></div>
                    <span id="mqtt-text">Conectando ao Broker MQTT...</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator disconnected" id="device-status"></div>
                    <span id="device-text">Dispositivo: Offline</span>
                </div>
            </div>
        </header>
        
        <div class="error-alert" id="error-alert">
            <strong>Erro:</strong> <span id="error-message"></span>
        </div>
        
        <div class="success-alert" id="success-alert">
            <strong>Sucesso:</strong> <span id="success-message"></span>
        </div>
        
        <div class="tab-container">
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="main">
                    <i class="fas fa-home"></i> Principal
                </button>
                <button class="tab-btn" data-tab="config">
                    <i class="fas fa-cogs"></i> Configurações
                </button>
                <button class="tab-btn" data-tab="schedule">
                    <i class="fas fa-clock"></i> Programação
                </button>
                <button class="tab-btn" data-tab="map">
                    <i class="fas fa-map"></i> Mapa
                </button>
                <button class="tab-btn" data-tab="mqtt">
                    <i class="fas fa-server"></i> MQTT
                </button>
            </div>
            
            <!-- ABA PRINCIPAL -->
            <div class="tab-content active" id="main">
                <div class="dashboard">
                    <div class="card">
                        <h2><i class="fas fa-cogs"></i> Controle do Sistema</h2>
                        
                        <div class="control-buttons">
                            <button class="btn-success" id="start-btn" disabled>
                                <i class="fas fa-play"></i> Iniciar
                            </button>
                            <button class="btn-danger" id="stop-btn" disabled>
                                <i class="fas fa-stop"></i> Parar
                            </button>
                            <button class="btn-warning" id="forward-btn" disabled>
                                <i class="fas fa-rotate-right"></i> Avanço
                            </button>
                            <button class="btn-warning" id="reverse-btn" disabled>
                                <i class="fas fa-rotate-left"></i> Reversão
                            </button>
                        </div>
                        
                        <div class="control-group">
                            <button class="btn-info" id="water-btn" disabled>
                                <i class="fas fa-tint"></i> Água
                            </button>
                        </div>
                        
                        <div class="control-group">
                            <label for="percentage">Percentímetro (0-100)%</label>
                            <input type="number" id="percentage" min="0" max="100" value="" placeholder="Digite a porcentagem">
                            <button class="btn-info" id="set-percentage" disabled>
                                <i class="fas fa-percentage"></i> Definir Porcentagem
                            </button>
                        </div>
                        
                        <div class="control-group">
                            <label for="water-layer">Lâmina de Água</label>
                            <input type="number" id="water-layer" step="0.1" value="" placeholder="Digite a lâmina de água">
                            <button class="btn-info" id="set-water-layer" disabled>
                                <i class="fas fa-ruler"></i> Definir Lâmina
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2><i class="fas fa-chart-bar"></i> Status do Sistema</h2>
                        
                        <div class="status-value">
                            <span class="status-label">Status:</span>
                            <span class="status-data" id="status-text">DESCONHECIDO</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">Equipamento:</span>
                            <span class="status-data" id="equipment-name-text">pivo</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">Direção:</span>
                            <span class="status-data" id="direction-text">N/A</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">Percentímetro:</span>
                            <span class="status-data" id="percentage-text">0%</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">Água:</span>
                            <span class="status-data" id="water-text">DESCONHECIDO</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">Pressão:</span>
                            <span class="status-data" id="pressure-text">SEM PRESSÃO</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">Lâmina de Água:</span>
                            <span class="status-data" id="water-layer-text">0.0</span>
                        </div>
                        
                        <!-- ===== NOVOS CAMPOS ADICIONADOS ===== -->
                        <div class="status-value">
                            <span class="status-label">Alimentação:</span>
                            <span class="status-data" id="power-supply-text">DESCONHECIDO</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">Em Ciclo:</span>
                            <span class="status-data" id="in-cycle-text">NÃO</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">Relé Ativo:</span>
                            <span class="status-data" id="relay-state-text">NÃO</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">Operação Programada:</span>
                            <span class="status-data" id="scheduled-operation-text">NÃO</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">GPS Sincronizado:</span>
                            <span class="status-data" id="gps-sync-text">NÃO</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">SIS:</span>
                            <span class="status-data" id="degree-stop-text">DESATIVADA</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">Grau Programado:</span>
                            <span class="status-data" id="target-degree-text">0°</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">Parado por grau:</span>
                            <span class="status-data" id="stopped-by-degree-text">NÃO</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">Posição Atual:</span>
                            <span class="status-data" id="position-text">0°</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">LoRa:</span>
                            <span class="status-data" id="lora-status-text">DESCONECTADO</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">Última Atualização:</span>
                            <span class="status-data" id="datetime-text">--/--/---- --:--:--</span>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2><i class="fas fa-bullseye"></i> Controle por Grau (SIS)</h2>
                        
                        <div class="control-group">
                            <label>Ativar SIS</label>
                            <div class="switch">
                                <input type="checkbox" id="sis-toggle">
                                <span class="slider"></span>
                            </div>
                            <span id="sis-status-text" style="margin-left: 10px;">Desativado</span>
                        </div>
                        
                        <div class="control-group">
                            <label for="target-degree">Grau</label>
                            <input type="number" id="target-degree" step="0.1" value="0.0" placeholder="Digite o grau">
                            <button class="btn-info" id="set-target-degree" disabled>
                                <i class="fas fa-bullseye"></i> Definir Grau
                            </button>
                        </div>
                        
                        <div class="control-group">
                            <label for="degree-tolerance">Tolerância (°)</label>
                            <input type="number" id="degree-tolerance" step="0.1" value="2.0" placeholder="Digite a tolerância">
                            <button class="btn-info" id="set-tolerance" disabled>
                                <i class="fas fa-adjust"></i> Definir Tolerância
                            </button>
                        </div>
                    </div>
                    
                    <!-- ===== NOVO CARD DE PROGRAMAÇÃO ===== -->
                    <div class="card">
                        <h2><i class="fas fa-calendar-alt"></i> Status da Programação</h2>
                        
                        <div class="status-value">
                            <span class="status-label">Programação:</span>
                            <span class="status-data" id="schedule-enabled-text">DESATIVADA</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">Horário:</span>
                            <span class="status-data" id="schedule-time-text">--:-- às --:--</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">Dias:</span>
                            <span class="status-data" id="schedule-days-text">Nenhum</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">Hoje Programado:</span>
                            <span class="status-data" id="today-scheduled-text">NÃO</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">No Horário:</span>
                            <span class="status-data" id="in-scheduled-time-text">NÃO</span>
                        </div>
                        
                        <div class="status-value">
                            <span class="status-label">Operação Manual:</span>
                            <span class="status-data" id="manual-operation-text">NÃO</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ABA CONFIGURAÇÕES -->
            <div class="tab-content" id="config">
                <div class="dashboard">
                    <div class="card">
                        <h2><i class="fas fa-wrench"></i> Configurações do Sistema</h2>
                        
                        <div class="control-group">
                            <label for="equipment-name">Nome do Equipamento</label>
                            <input type="text" id="equipment-name" value="Pivo" placeholder="Digite o nome do equipamento">
                        </div>
                        
                        <div class="control-group">
                            <label for="pressure-timeout">Tempo Pressão (segundos)</label>
                            <input type="number" id="pressure-timeout" value="" placeholder="Digite o tempo de pressão">
                        </div>
                        
                        <div class="control-group">
                            <label for="pivot-radius">Raio do Pivô (metros)</label>
                            <input type="number" id="pivot-radius" value="" placeholder="Digite o raio do pivô">
                        </div>
                        
                        <div class="control-group">
                            <label for="flow-rate">Vazão (m³/h)</label>
                            <input type="number" id="flow-rate" value="" placeholder="Digite a vazão">
                        </div>
                        
                        <div class="control-group">
                            <label for="base-rotation-time">Tempo de volta 100% (horas)</label>
                            <input type="number" id="base-rotation-time" value="" placeholder="Digite o tempo de rotação">
                        </div>
                        
                        <button class="btn-success" id="send-config" disabled>
                            <i class="fas fa-paper-plane"></i> Enviar Configurações
                        </button>
                        
                        <button class="btn-info" id="request-config" disabled>
                            <i class="fas fa-sync-alt"></i> Solicitar Configurações Atuais
                        </button>
                    </div>
                    
                    <div class="card">
                        <h2><i class="fas fa-list"></i> Configurações Recebidas</h2>
                        <div id="received-config" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; min-height: 200px; overflow-y: auto;">
                            <p>Nenhuma configuração recebida ainda.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ABA PROGRAMAÇÃO -->
            <div class="tab-content" id="schedule">
                <div class="card">
                    <h2><i class="fas fa-clock"></i> Programação de Horários</h2>
                    
                    <div class="control-group">
                        <label>Ativar Programação</label>
                        <div class="switch">
                            <input type="checkbox" id="schedule-toggle">
                            <span class="slider"></span>
                        </div>
                        <span id="schedule-status-text" style="margin-left: 10px;">Desativado</span>
                    </div>
                    
                    <div class="schedule-form">
                        <div class="time-inputs">
                            <div class="control-group">
                                <label for="start-time">Iniciar às:</label>
                                <input type="time" id="start-time" value="06:00">
                            </div>
                            
                            <div class="control-group">
                                <label for="stop-time">Parar às:</label>
                                <input type="time" id="stop-time" value="18:00">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label>Dias da Semana:</label>
                             <input type="checkbox" id="dom" value="0">
                                    <label for="dom">Domingo</label>
                                </div>
                                <div class="weekday">
                                    <input type="checkbox" id="seg" value="1">
                                    <label for="seg">Segunda</label>
                                </div>
                                <div class="weekday">
                            <div class="weekdays">
                                <div class="weekday">
                                   " id="ter" value="2">
                                    <label for="ter">Terça</label>
                                </div>
                                <div class="weekday">
                                    <input type="checkbox" id="qua" value="3">
                                    <label for="qua">Quarta</label>
                                </div>
                                <div class="weekday">
                                    <input type="checkbox" id="qui" value="4">
                                    <label for="qui">Quinta</label>
                                </div>
                                <div class="weekday">
                                    <input type="checkbox" id="sex" value="5">
                                    <label for="sex">Sexta</label>
                                </div>
                                <div class="weekday">
                                    <input type="checkbox" id="sab" value="6">
                                    <label for="sab">Sábado</label>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn-success" id="send-schedule" disabled>
                            <i class="fas fa-calendar-check"></i> Definir Programação
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ABA MAPA -->
            <div class="tab-content" id="map">
                <div class="card">
                    <h2><i class="fas fa-map"></i> Localização do Pivô</h2>
                    
                    <div class="control-group">
                        <label for="sensor-lat">Latitude:</label>
                        <input type="number" id="sensor-lat" step="0.000001" value="-19.360082" placeholder="Digite a latitude">
                    </div>
                    
                    <div class="control-group">
                        <label for="sensor-lon">Longitude:</label>
                        <input type="number" id="sensor-lon" step="0.000001" value="-47.364229" placeholder="Digite a longitude">
                    </div>
                    
                    <button class="btn-info" id="update-map">
                        <i class="fas fa-map-marker-alt"></i> Atualizar Localização
                    </button>
                    
                    <div class="map-container">
                        <div id="leaflet-map"></div>
                    </div>
                </div>
            </div>
            
            <!-- ABA MQTT -->
            <div class="tab-content" id="mqtt">
                <div class="card">
                    <h2><i class="fas fa-server"></i> Configuração MQTT</h2>
                    
                    <div class="control-group">
                        <label for="broker-url">URL do Broker MQTT</label>
                        <input type="text" id="broker-url" value="wss://mqtt.aguasanta.agr.br" placeholder="ws://seu-broker.com:porta" readonly>
                    </div>
                    
                    <div class="control-group">
                        <label for="command-topic">Tópico de Comando</label>
                        <input type="text" id="command-topic" value="ags/irrigation/command" placeholder="ags/irrigation/command" readonly>
                    </div>
                    
                    <div class="control-group">
                        <label for="status-topic">Tópico de Status</label>
                        <input type="text" id="status-topic" value="ags/irrigation/status" placeholder="ags/irrigation/status" readonly>
                    </div>
                    
                    <div class="control-group">
                        <label for="online-topic">Tópico de Online</label>
                        <input type="text" id="online-topic" value="ags/irrigation/online" placeholder="ags/irrigation/online" readonly>
                    </div>
                    
                    <div class="control-group">
                        <label for="config-topic">Tópico de Configuração</label>
                        <input type="text" id="config-topic" value="ags/irrigation/config" placeholder="ags/irrigation/config" readonly>
                    </div>
                    
                    <div class="control-group">
                        <label>Status da Conexão:</label>
                        <div style="padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                            <strong><span id="connection-status-text">Conectando automaticamente...</span></strong>
                        </div>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="btn-danger" id="disconnect-btn" disabled>
                            <i class="fas fa-power-off"></i> Desconectar
                        </button>
                        <button class="btn-info" id="reconnect-btn" style="display: none;">
                            <i class="fas fa-sync-alt"></i> Reconectar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Sistema AGS Irrigação carregado');
            
             // ================================================
            // CONFIGURAÇÕES MQTT EMBUTIDAS NO CÓDIGO
            // ================================================
            const MQTT_CONFIG = {
                // URL do broker MQTT
                BROKER_URL: 'wss://mqtt.aguasanta.agr.br',
                
                // Credenciais de autenticação
                USERNAME: 'coas',
                PASSWORD: 'AguaSanta@452',
                
                // Tópicos padrão
                COMMAND_TOPIC: 'ags/irrigation/command',
                STATUS_TOPIC: 'ags/irrigation/status',
                ONLINE_TOPIC: 'ags/irrigation/online',
                CONFIG_TOPIC: 'ags/irrigation/config',
                
                // Configurações de conexão
                CLIENT_ID: 'AGS_Irrigation_' + Math.random().toString(16).substr(2, 8),
                CONNECT_TIMEOUT: 5000,
                KEEPALIVE: 60
            };
            // ================================================
            
            // Variáveis globais
            let mqttClient = null;
            let isConnected = false;
            let waterState = false;
            let scheduleEnabled = false;
            let sisEnabled = false;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 10;
            let map = null;
            let marker = null;
            let currentEquipmentName = 'pivo';
            let deviceOnlineStatus = false;
            
            // Mapeamento de campos de configuração - CORRIGIDO
            const configFieldsMapping = {
                'equipment_name': 'equipment-name',
                'pressure_timeout': 'pressure-timeout',
                'pivot_radius': 'pivot-radius',
                'flow_rate': 'flow-rate',
                'base_rotation_time': 'base-rotation-time',
                'Nome_do_equipamento': 'equipment-name',
                'Tempo_de_pressao': 'pressure-timeout',
                'Raio_do_pivo': 'pivot-radius',
                'Vazao': 'flow-rate',
                'Tempo_de_volta_100': 'base-rotation-time'
            };
            
            // Elementos da UI centralizados
            const elements = {
                statusIndicator: document.getElementById('mqtt-status'),
                statusText: document.getElementById('mqtt-text'),
                deviceIndicator: document.getElementById('device-status'),
                deviceText: document.getElementById('device-text'),
                disconnectBtn: document.getElementById('disconnect-btn'),
                reconnectBtn: document.getElementById('reconnect-btn'),
                errorAlert: document.getElementById('error-alert'),
                successAlert: document.getElementById('success-alert'),
                errorMessage: document.getElementById('error-message'),
                successMessage: document.getElementById('success-message'),
                connectionStatusText: document.getElementById('connection-status-text'),
                dynamicSubtitle: document.getElementById('dynamic-subtitle'),
                receivedConfig: document.getElementById('received-config')
            };
            
            // Elementos de status centralizados - EXPANDIDO
            const statusElements = {
                status: document.getElementById('status-text'),
                equipmentName: document.getElementById('equipment-name-text'),
                direction: document.getElementById('direction-text'),
                percentage: document.getElementById('percentage-text'),
                water: document.getElementById('water-text'),
                pressure: document.getElementById('pressure-text'),
                waterLayer: document.getElementById('water-layer-text'),
                // === NOVOS CAMPOS ADICIONADOS ===
                powerSupply: document.getElementById('power-supply-text'),
                inCycle: document.getElementById('in-cycle-text'),
                relayState: document.getElementById('relay-state-text'),
                scheduledOperation: document.getElementById('scheduled-operation-text'),
                gpsSync: document.getElementById('gps-sync-text'),
                degreeStop: document.getElementById('degree-stop-text'),
                targetDegree: document.getElementById('target-degree-text'),
                stoppedByDegree: document.getElementById('stopped-by-degree-text'),
                position: document.getElementById('position-text'),
                loraStatus: document.getElementById('lora-status-text'),
                datetime: document.getElementById('datetime-text'),
                // === ELEMENTOS DE PROGRAMAÇÃO ===
                scheduleEnabledText: document.getElementById('schedule-enabled-text'),
                scheduleTimeText: document.getElementById('schedule-time-text'),
                scheduleDaysText: document.getElementById('schedule-days-text'),
                todayScheduledText: document.getElementById('today-scheduled-text'),
                inScheduledTimeText: document.getElementById('in-scheduled-time-text'),
                manualOperationText: document.getElementById('manual-operation-text')
            };
            
            // Lista de botões de controle - EXPANDIDA
            const controlButtons = [
                'start-btn', 'stop-btn', 'forward-btn', 'reverse-btn', 'water-btn',
                'set-percentage', 'set-water-layer', 'set-target-degree', 'set-tolerance',
                'send-config', 'send-schedule', 'request-config'
            ];
            
            // Função para atualizar o subtitle dinamicamente
            function updateSubtitle() {
                if (currentEquipmentName && currentEquipmentName.toLowerCase() !== 'pivo') {
                    elements.dynamicSubtitle.textContent = `${currentEquipmentName}`;
                } else {
                    elements.dynamicSubtitle.textContent = 'Sistema integrado de controle para irrigação via MQTT';
                }
            }
            
            // Sistema de abas
            function initTabs() {
                const tabButtons = document.querySelectorAll('.tab-btn');
                const tabContents = document.querySelectorAll('.tab-content');
                
                tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const targetTab = this.getAttribute('data-tab');
                        
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        tabContents.forEach(content => content.classList.remove('active'));
                        
                        this.classList.add('active');
                        document.getElementById(targetTab).classList.add('active');
                        
                        if (targetTab === 'map' && !map) {
                            setTimeout(initMap, 100);
                        }
                    });
                });
            }
            
            // Inicializar mapa
            function initMap() {
                try {
                    if (typeof L === 'undefined') {
                        console.warn('Leaflet não carregado');
                        return;
                    }
                    
                    const lat = parseFloat(document.getElementById('sensor-lat').value) || -19.360082;
                    const lon = parseFloat(document.getElementById('sensor-lon').value) || -47.364229;
                    
                    map = L.map('leaflet-map').setView([lat, lon], 15);
                    
                    L.tileLayer(
                        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                        {
                            attribution: 'Tiles &copy; Esri',
                            maxZoom: 50
                        }
                    ).addTo(map);
                    
                    marker = L.marker([lat, lon])
                        .addTo(map)
                        .bindPopup(currentEquipmentName ? `${currentEquipmentName} - Pivô de Irrigação` : 'Pivô de Irrigação')
                        .openPopup();
                        
                } catch (error) {
                    console.error('Erro ao inicializar mapa:', error);
                }
            }
            
            // Atualizar localização no mapa
            function updateMapLocation() {
                const lat = parseFloat(document.getElementById('sensor-lat').value);
                const lon = parseFloat(document.getElementById('sensor-lon').value);
                
                if (isNaN(lat) || isNaN(lon)) {
                    showError('Coordenadas inválidas');
                    return;
                }
                
                if (map && marker) {
                    marker.setLatLng([lat, lon]);
                    map.setView([lat, lon], 15);
                    marker.bindPopup(currentEquipmentName ? `${currentEquipmentName} - Pivô de Irrigação` : 'Pivô de Irrigação');
                    showSuccess('Localização atualizada no mapa');
                } else {
                    showError('Mapa não inicializado');
                }
            }
            
            // Funções de alerta otimizadas
            function showError(message) {
                elements.errorMessage.textContent = message;
                elements.errorAlert.style.display = 'block';
                elements.successAlert.style.display = 'none';
                setTimeout(() => elements.errorAlert.style.display = 'none', 5000);
                console.error('Erro:', message);
            }
            
            function showSuccess(message) {
                elements.successMessage.textContent = message;
                elements.successAlert.style.display = 'block';
                elements.errorAlert.style.display = 'none';
                setTimeout(() => elements.successAlert.style.display = 'none', 3000);
                console.log('Sucesso:', message);
            }
            
            function addMessage(topic, payload) {
                const now = new Date();
                const timestamp = `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}]`;
                console.log(`${timestamp} ${topic}: ${payload}`);
            }
            
            // Funções de status otimizadas
            function updateConnectionStatus(connected) {
                isConnected = connected;
                elements.statusIndicator.className = 'status-indicator ' + (connected ? 'connected' : 'disconnected');
                elements.statusText.textContent = connected ? 'Online' : 'Offline';
                elements.connectionStatusText.textContent = connected ? 'Conectado' : 'Desconectado';
                
                elements.disconnectBtn.disabled = !connected;
                
                if (connected) {
                    elements.reconnectBtn.style.display = 'none';
                } else {
                    elements.reconnectBtn.style.display = 'block';
                }
                
                controlButtons.forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    if (btn) btn.disabled = !connected;
                });
                
                if (connected) {
                    reconnectAttempts = 0;
                    showSuccess('Conectado ao broker MQTT com sucesso');
                }
            }
            
            // Atualizar status do dispositivo
            function updateDeviceOnlineStatus(online) {
                deviceOnlineStatus = online;
                elements.deviceIndicator.className = 'status-indicator ' + (online ? 'connected' : 'disconnected');
                elements.deviceText.textContent = `Dispositivo: ${online ? 'Online' : 'Offline'}`;
            }
            
            // Processar configurações recebidas - MELHORADO
            function processReceivedConfig(configData) {
                try {
                    let configDisplay = '<div style="font-family: monospace; font-size: 0.9rem;">';
                    let fieldsUpdated = 0;
                    
                    Object.entries(configData).forEach(([key, value]) => {
                        configDisplay += `<div><strong>${key}:</strong> ${value}</div>`;
                        
                        const fieldId = configFieldsMapping[key];
                        if (fieldId && value !== undefined && value !== null) {
                            const field = document.getElementById(fieldId);
                            if (field) {
                                field.value = value;
                                fieldsUpdated++;
                                console.log(`Campo ${fieldId} atualizado com valor: ${value}`);
                            }
                        }
                    });
                    
                    configDisplay += '</div>';
                    elements.receivedConfig.innerHTML = configDisplay;
                    
                    if (configData.equipment_name && configData.equipment_name !== currentEquipmentName) {
                        currentEquipmentName = configData.equipment_name;
                        updateSubtitle();
                        statusElements.equipmentName.textContent = currentEquipmentName;
                        if (marker) {
                            marker.bindPopup(`${currentEquipmentName} - Pivô de Irrigação`);
                        }
                    }
                    
                    showSuccess(`Configurações recebidas. ${fieldsUpdated} campo(s) atualizado(s).`);
                } catch (error) {
                    console.error('Erro ao processar configurações:', error);
                    showError('Erro ao processar configurações recebidas');
                }
            }
            
            // Conexão MQTT otimizada
            function connectToBroker() {
                const brokerUrl = MQTT_CONFIG.BROKER_URL;
                const commandTopic = MQTT_CONFIG.COMMAND_TOPIC;
                const statusTopic = MQTT_CONFIG.STATUS_TOPIC;
                const onlineTopic = MQTT_CONFIG.ONLINE_TOPIC;
                const configTopic = MQTT_CONFIG.CONFIG_TOPIC;
                const username = MQTT_CONFIG.USERNAME;
                const password = MQTT_CONFIG.PASSWORD;
                
                addMessage('Sistema', `Conectando ao broker: ${brokerUrl}`);
                elements.connectionStatusText.textContent = 'Conectando...';
                
                try {
                    const options = {
                        connectTimeout: MQTT_CONFIG.CONNECT_TIMEOUT,
                        keepalive: MQTT_CONFIG.KEEPALIVE,
                        clean: true,
                        reconnectPeriod: 3000,
                        clientId: MQTT_CONFIG.CLIENT_ID,
                        username: username,
                        password: password
                    };
                    
                    mqttClient = mqtt.connect(brokerUrl, options);
                    
                    mqttClient.on('connect', function() {
                        updateConnectionStatus(true);
                        addMessage('Sistema', 'Conectado com sucesso ao broker MQTT');
                        
                        const topics = [statusTopic, onlineTopic, configTopic];
                        
                        topics.forEach(topic => {
                            mqttClient.subscribe(topic, { qos: 1 }, function(err) {
                                if (!err) {
                                    addMessage('Sistema', `Inscrito no tópico: ${topic}`);
                                } else {
                                    showError(`Falha ao inscrever no tópico ${topic}: ${err.message}`);
                                }
                            });
                        });
                        
                        setTimeout(requestCurrentConfig, 1000);
                    });
                    
                    mqttClient.on('message', function(topic, message) {
                        const payload = message.toString();
                        addMessage(topic, payload);
                        
                        try {
                            if (topic === statusTopic) {
                                const statusData = JSON.parse(payload);
                                updateStatusDisplay(statusData);
                            } 
                            else if (topic === onlineTopic) {
                                const onlineData = JSON.parse(payload);
                                if (onlineData.hasOwnProperty('online')) {
                                    updateDeviceOnlineStatus(onlineData.online);
                                }
                            }
                            else if (topic === configTopic) {
                                const configData = JSON.parse(payload);
                                processReceivedConfig(configData);
                            }
                        } catch (e) {
                            console.warn('Mensagem não é JSON válido:', payload);
                        }
                    });
                    
                    mqttClient.on('error', function(err) {
                        showError(`Erro de conexão MQTT: ${err.message}`);
                        updateConnectionStatus(false);
                        elements.connectionStatusText.textContent = 'Erro de conexão';
                    });
                    
                    mqttClient.on('close', function() {
                        addMessage('Sistema', 'Conexão com o broker fechada');
                        updateConnectionStatus(false);
                        attemptReconnect();
                    });
                    
                    mqttClient.on('offline', function() {
                        addMessage('Sistema', 'Cliente MQTT offline');
                        updateConnectionStatus(false);
                        elements.connectionStatusText.textContent = 'Offline';
                    });
                    
                    mqttClient.on('reconnect', function() {
                        addMessage('Sistema', 'Tentando reconectar...');
                        elements.connectionStatusText.textContent = 'Reconectando...';
                    });
                    
                } catch (error) {
                    showError(`Falha ao conectar: ${error.message}`);
                    updateConnectionStatus(false);
                    elements.connectionStatusText.textContent = 'Falha na conexão';
                }
            }
            
            function attemptReconnect() {
                if (reconnectAttempts < maxReconnectAttempts && !isConnected) {
                    reconnectAttempts++;
                    addMessage('Sistema', `Tentativa de reconexão ${reconnectAttempts}/${maxReconnectAttempts}...`);
                    setTimeout(() => {
                        if (!isConnected) connectToBroker();
                    }, 5000 * reconnectAttempts);
                } else if (!isConnected) {
                    addMessage('Sistema', 'Número máximo de tentativas de reconexão atingido');
                    elements.connectionStatusText.textContent = 'Falha na conexão';
                }
            }
            
            function disconnectFromBroker() {
                if (mqttClient) {
                    mqttClient.end(true);
                    mqttClient = null;
                    addMessage('Sistema', 'Desconectado do broker MQTT');
                    updateConnectionStatus(false);
                    showSuccess('Desconectado do broker MQTT');
                }
            }
            
            function reconnectToBroker() {
                reconnectAttempts = 0;
                connectToBroker();
            }
            
            function publishMessage(topic, message) {
                if (mqttClient && isConnected) {
                    mqttClient.publish(topic, message, { qos: 1 }, function(err) {
                        if (err) {
                            showError(`Erro ao enviar comando: ${err.message}`);
                        } else {
                            addMessage(`Enviado para ${topic}`, message);
                        }
                    });
                } else {
                    showError('Não conectado ao broker MQTT');
                }
            }
            
            function requestCurrentConfig() {
                publishMessage(MQTT_CONFIG.CONFIG_TOPIC, JSON.stringify({
                    action: "get_config",
                    timestamp: Date.now()
                }));
                showSuccess('Solicitação de configurações enviada');
            }
            
            // Função EXPANDIDA para atualizar status
            function updateStatusDisplay(data) {
                const mappings = {
                    // Campos básicos existentes
                    'Status': 'status',
                    'Nome_do_equipamento': 'equipmentName',
                    'Direçao': 'direction',
                    'Direcao': 'direction',
                    'Percentimetro': 'percentage',
                    'Agua': 'water',
                    'Pressao': 'pressure',
                    'Lamina': 'waterLayer',
                    'Parada_por_grau': 'degreeStop',
                    'Grau_alvo': 'targetDegree',
                    'Parado_por_grau': 'stoppedByDegree',
                    'Posicao_atual': 'position',
                    'Ultima_atualização': 'datetime',
                    'Ultima_atualizacao': 'datetime',
                    // === NOVOS CAMPOS ADICIONADOS ===
                    'Alimentacao': 'powerSupply',
                    'Em_ciclo': 'inCycle',
                    'Rele_ativo': 'relayState',
                    'Operacao_programada': 'scheduledOperation',
                    'GPS_sincronizado': 'gpsSync',
                    'LoRa_conectado': 'loraStatus',
                    // === CAMPOS DE PROGRAMAÇÃO ===
                    'Programacao_ativa': 'scheduleEnabledText',
                    'Hora_inicio': 'scheduleTimeText',
                    'Hora_fim': 'scheduleTimeText',
                    'Dias_programados': 'scheduleDaysText',
                    'Hoje_programado': 'todayScheduledText',
                    'No_horario_programado': 'inScheduledTimeText',
                    'Operacao_manual': 'manualOperationText'
                };
                
                Object.entries(data).forEach(([key, value]) => {
                    const elementKey = mappings[key];
                    if (elementKey && statusElements[elementKey]) {
                        let displayValue = value;
                        
                        if (key === 'Percentimetro') displayValue += '%';
                        else if (key === 'Grau_alvo' || key === 'Posicao_atual') displayValue += '°';
                        
                        // === TRATAMENTO ESPECIAL PARA HORÁRIOS ===
                        if (key === 'Hora_inicio' && data['Hora_fim']) {
                            statusElements.scheduleTimeText.textContent = `${data['Hora_inicio']} às ${data['Hora_fim']}`;
                            return;
                        }
                        if (key === 'Hora_fim') return; // Já processado acima
                        
                        statusElements[elementKey].textContent = displayValue;
                        
                        if (key === 'Nome_do_equipamento') {
                            const newEquipmentName = value.toString().trim();
                            if (newEquipmentName && newEquipmentName !== currentEquipmentName) {
                                currentEquipmentName = newEquipmentName;
                                updateSubtitle();
                                const equipmentNameInput = document.getElementById('equipment-name');
                                if (equipmentNameInput) {
                                    equipmentNameInput.value = currentEquipmentName;
                                }
                                if (marker) {
                                    marker.bindPopup(`${currentEquipmentName} - Pivô de Irrigação`);
                                }
                            }
                        }
                        
                        if (key === 'Agua') {
                            const waterBtn = document.getElementById('water-btn');
                            const isWaterOn = value.toUpperCase() === 'LIGADA' || value.toUpperCase() === 'ON';
                            waterBtn.innerHTML = isWaterOn ? 
                                '<i class="fas fa-tint"></i> Água' : 
                                '<i class="fas fa-tint-slash"></i> Água';
                            waterState = isWaterOn;
                        }
                        
                        // === ATUALIZAR SWITCHES COM BASE NO STATUS ===
                        if (key === 'Parada_por_grau') {
                            const sisToggle = document.getElementById('sis-toggle');
                            const sisStatusText = document.getElementById('sis-status-text');
                            const isActive = value.toUpperCase() === 'ATIVADA';
                            sisToggle.checked = isActive;
                            sisStatusText.textContent = isActive ? 'Ativado' : 'Desativado';
                            sisEnabled = isActive;
                        }
                        
                        if (key === 'Programacao_ativa') {
                            const scheduleToggle = document.getElementById('schedule-toggle');
                            const scheduleStatusText = document.getElementById('schedule-status-text');
                            const isActive = value.toUpperCase() === 'SIM';
                            scheduleToggle.checked = isActive;
                            scheduleStatusText.textContent = isActive ? 'Ativado' : 'Desativado';
                            scheduleEnabled = isActive;
                        }
                    }
                });
                
                if (!data.Ultima_atualização && !data.Ultima_atualizacao) {
                    const now = new Date();
                    const timestamp = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                    statusElements.datetime.textContent = timestamp + ' (Sistema)';
                }
            }
            
            // Validação numérica
            function validateNumericInput(value, min, max, fieldName) {
                const num = parseFloat(value);
                if (isNaN(num)) {
                    showError(`${fieldName} deve ser um número válido`);
                    return false;
                }
                if (min !== undefined && num < min) {
                    showError(`${fieldName} deve ser maior ou igual a ${min}`);
                    return false;
                }
                if (max !== undefined && num > max) {
                    showError(`${fieldName} deve ser menor ou igual a ${max}`);
                    return false;
                }
                return true;
            }
            
            // Configurar event listeners - EXPANDIDO
            function setupEventListeners() {
                // Switch do SIS
                const sisToggle = document.getElementById('sis-toggle');
                const sisStatusText = document.getElementById('sis-status-text');
                
                sisToggle.addEventListener('change', function() {
                    sisEnabled = this.checked;
                    const command = `Q:${sisEnabled ? 1 : 0}`;
                    publishMessage(MQTT_CONFIG.COMMAND_TOPIC, command);
                    sisStatusText.textContent = sisEnabled ? 'Ativado' : 'Desativado';
                    showSuccess(`SIS ${sisEnabled ? 'ativado' : 'desativado'}`);
                });
                
                document.querySelector('#sis-toggle + .slider').addEventListener('click', function(e) {
                    e.stopPropagation();
                    sisToggle.checked = !sisToggle.checked;
                    const event = new Event('change');
                    sisToggle.dispatchEvent(event);
                });
                
                // Switch da Programação
                const scheduleToggle = document.getElementById('schedule-toggle');
                const scheduleStatusText = document.getElementById('schedule-status-text');
                
                scheduleToggle.addEventListener('change', function() {
                    scheduleEnabled = this.checked;
                    const command = `E:${scheduleEnabled ? 1 : 0}`;
                    publishMessage(MQTT_CONFIG.COMMAND_TOPIC, command);
                    scheduleStatusText.textContent = scheduleEnabled ? 'Ativado' : 'Desativado';
                    showSuccess(`Programação ${scheduleEnabled ? 'ativada' : 'desativada'}`);
                });
                
                document.querySelector('#schedule-toggle + .slider').addEventListener('click', function(e) {
                    e.stopPropagation();
                    scheduleToggle.checked = !scheduleToggle.checked;
                    const event = new Event('change');
                    scheduleToggle.dispatchEvent(event);
                });
                
                // Conectar/Desconectar
                elements.disconnectBtn.addEventListener('click', disconnectFromBroker);
                elements.reconnectBtn.addEventListener('click', reconnectToBroker);
                
                // Solicitar configurações
                document.getElementById('request-config').addEventListener('click', requestCurrentConfig);
                
                // Comandos do sistema unificados
                const commands = {
                    'start-btn': { cmd: 'L', msg: 'Iniciar Sistema' },
                    'stop-btn': { cmd: 'D', msg: 'Parar Sistema' },
                    'forward-btn': { cmd: 'A', msg: 'Avanço' },
                    'reverse-btn': { cmd: 'R', msg: 'Reversão' },
                    'water-btn': { 
                        cmd: () => waterState ? 'B' : 'W', 
                        msg: () => `${waterState ? 'Desligar' : 'Ligar'} Água` 
                    }
                };
                
                Object.entries(commands).forEach(([btnId, config]) => {
                    document.getElementById(btnId).addEventListener('click', function() {
                        const cmd = typeof config.cmd === 'function' ? config.cmd() : config.cmd;
                        const msg = typeof config.msg === 'function' ? config.msg() : config.msg;
                        publishMessage(MQTT_CONFIG.COMMAND_TOPIC, cmd);
                        showSuccess(`Comando "${msg}" enviado`);
                    });
                });
                
                // Controles com valores unificados - CORRIGIDO
                const valueControls = [
                    { btn: 'set-percentage', input: 'percentage', prefix: 'P:', validation: [0, 100], unit: '%' },
                    { btn: 'set-water-layer', input: 'water-layer', prefix: 'S:', validation: [0] },
                    { btn: 'set-target-degree', input: 'target-degree', prefix: 'G:', validation: [0, 359], unit: '°' },
                    { btn: 'set-tolerance', input: 'degree-tolerance', prefix: 'Y:', validation: [0.1, 10], unit: '°' }
                ];
                
                valueControls.forEach(control => {
                    document.getElementById(control.btn).addEventListener('click', function() {
                        const value = document.getElementById(control.input).value;
                        const fieldName = document.querySelector(`label[for="${control.input}"]`).textContent;
                        
                        if (validateNumericInput(value, control.validation[0], control.validation[1], fieldName)) {
                            publishMessage(MQTT_CONFIG.COMMAND_TOPIC, `${control.prefix}${value}`);
                            showSuccess(`${fieldName} definido para ${value}${control.unit || ''}`);
                        }
                    });
                });
                
                // Configurações
                document.getElementById('send-config').addEventListener('click', function() {
                    const equipmentNameValue = document.getElementById('equipment-name').value.trim();
                    
                    const config = {
                        equipment_name: equipmentNameValue,
                        pressure_timeout: document.getElementById('pressure-timeout').value,
                        pivot_radius: document.getElementById('pivot-radius').value,
                        flow_rate: document.getElementById('flow-rate').value,
                        base_rotation_time: document.getElementById('base-rotation-time').value,
                        timestamp: Date.now(),
                        source: "WebInterface"
                    };
                    
                    Object.keys(config).forEach(key => {
                        if (!config[key] && config[key] !== 0) delete config[key];
                    });
                    
                    if (Object.keys(config).length <= 2) {
                        showError('Preencha pelo menos um campo de configuração');
                        return;
                    }
                    
                    if (equipmentNameValue && equipmentNameValue !== currentEquipmentName) {
                        currentEquipmentName = equipmentNameValue;
                        updateSubtitle();
                        statusElements.equipmentName.textContent = currentEquipmentName;
                        if (marker) {
                            marker.bindPopup(`${currentEquipmentName} - Pivô de Irrigação`);
                        }
                    }
                    
                    publishMessage(MQTT_CONFIG.CONFIG_TOPIC, JSON.stringify(config));
                    showSuccess('Configurações enviadas');
                });
                
                // Programação - COMANDOS CORRIGIDOS
                document.getElementById('send-schedule').addEventListener('click', function() {
                    const startTime = document.getElementById('start-time').value;
                    const stopTime = document.getElementById('stop-time').value;
                    
                    if (!startTime || !stopTime) {
                        showError('Preencha os horários de início e parada');
                        return;
                    }
                    
                    const startFormatted = startTime.replace(':', '');
                    const stopFormatted = stopTime.replace(':', '');
                    
                    const weekdays = ['dom', 'seg', 'ter', 'qua', 'qui', 'sex', 'sab'];
                    let daysMask = 0;
                    
                    weekdays.forEach((day, index) => {
                        const checkbox = document.getElementById(day);
                        if (checkbox?.checked) daysMask |= (1 << index);
                    });
                    
                    // === CORREÇÃO: COMANDOS CORRETOS ===
                    publishMessage(MQTT_CONFIG.COMMAND_TOPIC, `I:${startFormatted}`); // I = Início
                    publishMessage(MQTT_CONFIG.COMMAND_TOPIC, `J:${stopFormatted}`);  // J = Fim
                    publishMessage(MQTT_CONFIG.COMMAND_TOPIC, `K:${daysMask}`);       // K = Máscara dias
                    
                    showSuccess(`Programação definida: ${startTime} às ${stopTime}`);
                });
                
                // Mapa
                document.getElementById('update-map').addEventListener('click', updateMapLocation);
                
                // Enter key listeners unificados - EXPANDIDO
                ['percentage', 'water-layer', 'target-degree', 'degree-tolerance'].forEach(inputId => {
                    document.getElementById(inputId).addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            const btnMap = {
                                'percentage': 'set-percentage',
                                'water-layer': 'set-water-layer',
                                'target-degree': 'set-target-degree',
                                'degree-tolerance': 'set-tolerance'
                            };
                            document.getElementById(btnMap[inputId]).click();
                        }
                    });
                });
            }
            
            // Inicialização
            console.log('Inicializando sistema...');
            updateConnectionStatus(false);
            updateDeviceOnlineStatus(false);
            initTabs();
            setupEventListeners();
            
            // Preencher os campos com as configurações embutidas
            document.getElementById('broker-url').value = MQTT_CONFIG.BROKER_URL;
            document.getElementById('command-topic').value = MQTT_CONFIG.COMMAND_TOPIC;
            document.getElementById('status-topic').value = MQTT_CONFIG.STATUS_TOPIC;
            document.getElementById('online-topic').value = MQTT_CONFIG.ONLINE_TOPIC;
            document.getElementById('config-topic').value = MQTT_CONFIG.CONFIG_TOPIC;
            
            updateSubtitle();
            
            setTimeout(() => {
                if (typeof mqtt !== 'undefined') {
                    addMessage('Sistema', 'Sistema carregado com sucesso. Conectando automaticamente ao broker MQTT.');
                } else {
                    showError('Biblioteca MQTT não carregada. Verifique sua conexão com a internet.');
                }
            }, 1000);
            
            // Atualização de timestamp
            setInterval(() => {
                if (isConnected && statusElements.datetime.textContent === '--/--/---- --:--:--') {
                    const now = new Date();
                    const timestamp = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                    statusElements.datetime.textContent = timestamp + ' (Sistema)';
                }
            }, 5000);
            
            // Conectar automaticamente ao carregar a página
            setTimeout(() => {
                addMessage('Sistema', 'Conectando automaticamente ao broker MQTT...');
                connectToBroker();
            }, 1000);
        });
    </script>
</body>
</html>
